<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>M3U8 Player</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body{margin:0;font-family:system-ui;background:#0b0f17;color:#e5e7eb}
    header{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:12px 14px;border-bottom:1px solid #1f2937}
    input,select,button{padding:10px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:#e5e7eb}
    button{cursor:pointer}
    .wrap{display:grid;grid-template-columns:2fr 1fr;gap:12px;padding:12px;height:calc(100vh - 74px);box-sizing:border-box}
    .panel{border:1px solid #1f2937;border-radius:14px;overflow:hidden;background:#000}
    video,iframe{width:100%;height:100%;border:0}
    .log{white-space:pre-wrap;background:#0f172a;border:1px solid #334155;border-radius:14px;padding:10px;max-height:180px;overflow:auto}
    @media (max-width: 980px){.wrap{grid-template-columns:1fr;height:auto}.panel{height:60vh}}
  </style>
</head>
<body>

<header>
  <span>m3u8:</span>
  <input id="src" style="min-width:340px;flex:1" placeholder="m3u8 linkini yapıştır" />
  <button id="play">Oynat</button>
  <span>Kalite:</span>
  <select id="q"><option value="-1">Auto</option></select>
</header>

<div class="wrap">
  <div class="panel"><video id="v" controls autoplay playsinline></video></div>
  <div style="display:flex;flex-direction:column;gap:12px;min-height:0">
    <div class="panel" style="flex:1;min-height:280px">
      <iframe src="https://kick.com/chips/chat"></iframe>
    </div>
    <div class="log" id="log"></div>
  </div>
</div>

<script>
  const WORKER_URL = "https://p.dalinpepe2.workers.dev"; // <- BURAYI DEĞİŞTİR

  const video = document.getElementById("v");
  const srcInput = document.getElementById("src");
  const qSel = document.getElementById("q");
  const logEl = document.getElementById("log");
  let hls;

  function log(s){ logEl.textContent += s + "\n"; }
  function destroy(){ if(hls){hls.destroy();hls=null;} video.removeAttribute("src"); video.load(); }

  function proxify(u){
    return `${WORKER_URL}/?u=${encodeURIComponent(u)}`;
  }

  function load(url){
    url = (url||"").trim();
    if(!url) return;

    logEl.textContent = "";
    log("Loading: " + url);

    destroy();

    const purl = proxify(url);

    if (video.canPlayType("application/vnd.apple.mpegurl")) {
      video.src = purl;
      video.play().catch(e => log("play() error: " + e));
      log("Native HLS (via Worker).");
      return;
    }

    if (!window.Hls || !Hls.isSupported()) {
      log("Hls.js not supported.");
      return;
    }

    hls = new Hls({ startLevel:-1, capLevelToPlayerSize:true, lowLatencyMode:true });

    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      qSel.innerHTML = '<option value="-1">Auto</option>';
      hls.levels.forEach((lvl,i)=>{
        const label = (lvl.height ? `${lvl.height}p` : `Level ${i}`) +
          (lvl.bitrate ? ` (${Math.round(lvl.bitrate/1000)} kbps)` : "");
        const opt=document.createElement("option");
        opt.value=String(i); opt.textContent=label;
        qSel.appendChild(opt);
      });
      log("Levels: " + hls.levels.length);
    });

    qSel.onchange = () => {
      hls.currentLevel = parseInt(qSel.value,10);
      log("Quality: " + qSel.options[qSel.selectedIndex].text);
    };

    hls.on(Hls.Events.ERROR, (_, data) => {
      log(`ERROR type=${data.type} details=${data.details} fatal=${data.fatal}`);
      if (data.response?.code) log("HTTP: " + data.response.code);
    });

    hls.loadSource(purl);
    hls.attachMedia(video);
  }

  document.getElementById("play").onclick = () => load(srcInput.value);

  // URL param: ?m3u8=...
  const p = new URLSearchParams(location.search);
  const paramUrl = p.get("m3u8");
  if (paramUrl) srcInput.value = decodeURIComponent(paramUrl);
</script>

</body>
</html>
